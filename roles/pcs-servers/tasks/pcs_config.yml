---
- name: Configuring cluster (step 1)
  ansible.builtin.command: "{{ item }}"
  with_items:
    - "pcs host auth pcs-01.{{ domain }} pcs-02.{{ domain }} pcs-03.{{ domain }} -u hacluster -p {{ pcs_password }}"
  #no_log: true

- name: Check for replay (/opt/pcs_config_done exists)
  ansible.builtin.stat:
    path: /opt/pcs_config_done
  register: pcs_config_done

- name: Configuring cluster (step 2)
  ansible.builtin.command: "{{ item }}"
  with_items:
    - "pcs cluster setup {{ cluster_name }} pcs-01.{{ domain }} pcs-02.{{ domain }} pcs-03.{{ domain }}"
  when:
    - pcs_config_done.stat.exists != True

# touch /opt/pcs_config_done
- name: Set replay protection (/opt/pcs_config_done)
  ansible.builtin.file:
    path: /opt/pcs_config_done
    state: touch
    owner: root
    group: root
    mode: '0744'
  when:
    - pcs_config_done.stat.exists != True

- name: Configuring cluster (step 3)
  ansible.builtin.command: "{{ item }}"
  with_items:
    - "pcs cluster enable --all"
    - "pcs cluster start --all"

# https://www.golinuxcloud.com/setup-high-availability-cluster-centos-8/

# pcs property set stonith-enabled=false
- name: pcs property set stonith-enabled=false
  ansible.builtin.command: pcs property set stonith-enabled=false

# pcs property set no-quorum-policy=freeze
- name: pcs property set no-quorum-policy=freeze
  ansible.builtin.command: pcs property set no-quorum-policy=freeze

#### Вместо lvmlockd заменить LVMLOCKD ####

## pcs resource create dlm systemd:dlm op monitor interval=30s on-fail=ignore clone interleave=true ordered=true
#- name: pcs resource create dlm systemd:dlm op monitor interval=30s on-fail=ignore clone interleave=true ordered=true
#  ansible.builtin.command: pcs resource create dlm systemd:dlm op monitor interval=30s on-fail=ignore clone interleave=true ordered=true

## pcs resource create lvmlockd ocf:heartbeat:clvm op monitor interval=30s on-fail=ignore clone interleave=true ordered=true
#- name: pcs resource create lvmlockd ocf:heartbeat:lvmlock op monitor interval=30s on-fail=ignore clone interleave=true ordered=true
#  ansible.builtin.command: pcs resource create lvmlockd ocf:heartbeat:lvmlockd op monitor interval=30s on-fail=ignore clone interleave=true ordered=true

## pcs constraint order start dlm-clone then lvmlockd-clone
#- name: pcs constraint order start dlm-clone then lvmlockd-clone
#  ansible.builtin.command: pcs constraint order start dlm-clone then lvmlockd-clone

- name: Include lvm2
  include_tasks: lvm2.yml
  when: "ansible_hostname in 'pcs-01'"

- name: Include gfs2
  include_tasks: gfs2.yml
  when: "ansible_hostname in 'pcs-01'"

## pcs resource create clusterfs Filesystem device="/dev/cluster_vg/cluster_lv" directory="/mnt/gfs2" fstype="gfs2" "options=noatime" op monitor interval=10s on-fail=ignore clone interleave=true
#- name: pcs resource create clusterfs Filesystem device="/dev/cluster_vg/cluster_lv" directory="/mnt/gfs2" fstype="gfs2" "options=noatime" op monitor interval=10s on-fail=ignore clone interleave=true
#  ansible.builtin.command: pcs resource create clusterfs Filesystem device="/dev/cluster_vg/cluster_lv" directory="/mnt/gfs2" fstype="gfs2" "options=noatime" op monitor interval=10s on-fail=ignore clone interleave=true

## pcs constraint order start lvmlockd-clone then clusterfs-clone
#- name: pcs constraint order start lvmlockd-clone then clusterfs-clone
#  ansible.builtin.command: pcs constraint order start lvmlockd-clone then clusterfs-clone

## pcs constraint colocation add clusterfs-clone with lvmlockd-clone
#- name: pcs constraint colocation add clusterfs-clone with lvmlockd-clone
#  ansible.builtin.command: pcs constraint colocation add clusterfs-clone with lvmlockd-clone



# pcs resource create fileio_cluster ocf:heartbeat:LVM-activate vgname=fileio_cluster_vg activation_mode=exclusive vg_access_mode=system_id --group HA-LVM
- name: pcs resource create name_cluster ocf:heartbeat:LVM-activate vgname=cluster_vg activation_mode=exclusive vg_access_mode=system_id --group HA-LVM
  ansible.builtin.command: "pcs resource create {{ item.name }} ocf:heartbeat:LVM-activate vgname={{ item.vg }} activation_mode=exclusive vg_access_mode=system_id --group {{ item.group }}"
  with_items: 
    - { name: 'fileio_cluster_vg', vg: 'fileio_cluster_vg', group: 'HA-LVM-FILE0' }
    - { name: 'block_cluster_vg', vg: 'block_cluster_vg', group: 'HA-LVM-BLOCK0' }

# pcs resource create my-fs ocf:heartbeat:Filesystem device=/dev/cluster_vg/cluster_lv directory=/mnt/lvm_cluster fstype=gfs2 --group HA-LVM
- name: pcs property set no-quorum-policy=freeze
  ansible.builtin.command: "pcs resource create {{ item.name }} ocf:heartbeat:Filesystem device={{ item.device }} directory={{ item.mnt }} fstype=gfs2 --group {{ item.group }}"
  with_items: 
    - { name: 'fileio_cluster_fs', device: '/dev/fileio_cluster_vg/file0_cluster_lv', mnt: '/mnt/lvm_cluster_file0', group: 'HA-LVM-FILE0' }
    - { name: 'block_cluster_fs', device: '/dev/block_cluster_vg/block0_cluster_lv', mnt: '/mnt/lvm_cluster_block0', group: 'HA-LVM-BLOCK0' }
